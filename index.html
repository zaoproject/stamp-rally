<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡易QRコードリーダー</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 500px;
            width: 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        h1 {
            color: #007bff;
        }
        #qr-scanner-button {
            display: block;
            width: 80%;
            padding: 15px;
            margin: 20px auto;
            background-color: #28a745; /* 緑系の色に */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #qr-scanner-button:hover {
            background-color: #218838;
        }
        #qr-reader {
            width: 100%;
            margin-top: 20px;
            display: none; /* 初期状態では非表示 */
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden; /* ビデオが枠からはみ出さないように */
        }
        #qr-reader video {
            width: 100% !important; /* ライブラリのスタイルを上書き */
            height: auto !important; /* ライブラリのスタイルを上書き */
        }
        #qr-reader-results {
            margin-top: 20px;
            padding: 15px;
            background-color: #e2e3e5;
            border-radius: 5px;
            min-height: 50px;
            word-break: break-all; /* 長いURLなどで改行 */
            text-align: left;
        }
        .error-message {
            color: #dc3545; /* 赤色 */
            font-weight: bold;
            margin-top: 10px;
        }
        .info-message {
            color: #007bff; /* 青色 */
            margin-top: 10px;
        }
    </style>
    <script src="./html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>QRコードリーダー</h1>
        <p class="info-message">
            「スキャン開始」ボタンを押すとカメラが起動します。<br>
            ブラウザからカメラの許可を求められた場合は「**許可**」を選択してください。
        </p>

        <button id="qr-scanner-button">スキャン開始</button>

        <div id="qr-reader"></div>

        <h2>スキャン結果:</h2>
        <div id="qr-reader-results">
            読み取られたQRコードのデータがここに表示されます。
        </div>

    </div>

    <script>
        const qrScannerButton = document.getElementById('qr-scanner-button');
        const qrReader = document.getElementById('qr-reader');
        const qrReaderResults = document.getElementById('qr-reader-results');

        let html5QrCode = null; // Html5Qrcodeインスタンスを保持する変数

        qrScannerButton.addEventListener('click', () => {
            // ボタンがクリックされたら、QRリーダーを表示し、ボタンを非表示にする
            qrReader.style.display = 'block';
            qrScannerButton.style.display = 'none';
            qrReaderResults.innerHTML = '<span class="info-message">カメラを起動中...</span>'; // 読み取り結果を初期化

            // html5QrCodeインスタンスがまだ生成されていなければ生成する
            if (html5QrCode === null) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }

            // カメラの起動とQRコードスキャンの開始
            html5QrCode.start(
                { facingMode: "environment" }, // 背面カメラを使用
                {
                    fps: 10,  // フレームレート
                    qrbox: { width: 250, height: 250 } // QRコードの読み取り範囲のボックスサイズ
                },
                (decodedText, decodedResult) => {
                    // QRコードが正常に読み取られた時の処理
                    qrReaderResults.innerHTML = `<strong>成功:</strong> ${decodedText}`;
                    qrReaderResults.style.color = '#333'; // 通常のテキスト色に戻す

                    // スキャンが成功したらカメラを停止し、UIを元に戻す
                    html5QrCode.stop().then(() => {
                        qrReader.style.display = 'none';
                        qrScannerButton.style.display = 'block';
                        // html5QrCode = null; // 再スキャン時にインスタンスを再生成する場合はコメントアウトを外す
                    }).catch((err) => {
                        console.error("QRスキャナー停止エラー:", err);
                        qrReaderResults.innerHTML += `<br><span class="error-message">スキャナー停止時にエラーが発生しました。</span>`;
                    });
                },
                (errorMessage) => {
                    // QRコードが読み取れない時の処理 (エラーログは表示しないことが多い)
                    // console.warn(`QRコードスキャンエラー: ${errorMessage}`);
                }
            ).catch((err) => {
                // カメラ起動失敗時のエラー処理 (ユーザーへのフィードバック)
                let userMessage = `<strong>カメラの起動に失敗しました。</strong><br>`;
                if (err.name === 'NotAllowedError') {
                    userMessage += `カメラの使用が許可されていません。<br>ブラウザやスマートフォンの設定でカメラへのアクセスを許可してください。`;
                } else if (err.name === 'NotFoundError') {
                    userMessage += `利用可能なカメラが見つかりませんでした。<br>別のカメラが使用中でないかご確認ください。`;
                } else {
                    userMessage += `予期せぬエラーが発生しました。<br>エラーコード: ${err.message}`;
                }
                qrReaderResults.innerHTML = `<span class="error-message">${userMessage}</span>`;
                qrReader.style.display = 'none';
                qrScannerButton.style.display = 'block';
                console.error("カメラ起動エラー:", err); // 開発者向けの詳細なログ
            });
        });
    </script>
</body>
</html>
